machine:
  node:
    version: 8.1.3
  environment:
    SHORT_SHA: $(echo $CIRCLE_SHA1 | cut -b1-7)
    TAG: ${CIRCLE_BRANCH:-$(echo $CIRCLE_TAG)}
    AWS_DEFAULT_REGION: "us-west-2"
    PORT: 3001
    SERVERHOST: test-form.io
    SERVERPROTOCOL: https
  java:
    version:
      oraclejdk8

dependencies:
  pre:
    - curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - sudo dpkg -i google-chrome.deb
    - sudo sed -i 's|HERE/chrome\"|HERE/chrome\" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
    - rm google-chrome.deb
    - wget http://selenium-release.storage.googleapis.com/3.9/selenium-server-standalone-3.9.1.jar
    - java -jar selenium-server-standalone-3.9.1.jar:
        background: true
    - pip install awscli
    - npm install -g bower gulp mocha
  override:
    - ./appSetup.sh
    - echo $TAG > dist/version.txt
    - sed -i "s|APP_VERSION|${TAG}|g" dist/config.js

test:
  pre:
    - sudo bash -c "echo \"127.0.0.1 portal.localhost\" >> /etc/hosts"
    - mkdir ./test/screenshots
    - npm start:
        background: true
  post:
    - mv ./test/screenshots/ $CIRCLE_ARTIFACTS/screenshots

deployment:
  prerelease:
    tag: /^\d+\.\d+\.\d+(-.*)$/
    commands:
      - cd dist && tar -czvf ../${TAG}.tgz *
      - aws s3 cp ${TAG}.tgz s3://formio-app-releases/${TAG}.tgz
  release:
    tag: /^\d+\.\d+\.\d+$/
    commands:
      - cd dist && tar -czvf ../${TAG}.tgz *
      - aws s3 cp ${TAG}.tgz s3://formio-app-releases/${TAG}.tgz
