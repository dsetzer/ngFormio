machine:
  node:
    version: 8.1.3
  environment:
    SHORT_SHA: $(echo $CIRCLE_SHA1 | cut -b1-7)
    TAG: ${CIRCLE_BRANCH:-$(echo $CIRCLE_TAG)}
    AWS_DEFAULT_REGION: "us-west-2"
    PORT: 3001
    SERVERHOST: test-form.io
    SERVERPROTOCOL: https
  java:
    version:
      oraclejdk8

dependencies:
  pre:
    - wget https://saucelabs.com/downloads/sc-4.3.13-linux.tar.gz --no-check-certificate
    - tar -xzf sc-4.3.13-linux.tar.gz
    - wget http://selenium-release.storage.googleapis.com/3.11/selenium-server-standalone-3.11.0.jar
    - java -jar selenium-server-standalone-3.11.0.jar:
        background: true
    - pip install awscli
    - npm install -g bower gulp mocha
  override:
    - ./appSetup.sh
    - echo $TAG > dist/version.txt
    - sed -i "s|APP_VERSION|${TAG}|g" dist/config.js
test:
  override:
    - sc-4.3.13-linux/bin/sc -u travist -k 1c32baf7-f790-4a41-ae31-49c0972e13e7 --readyfile ~/sauce_is_ready:
        background: true
      pwd: sc-*-linux
    # Wait for tunnel to be ready
    - while [ ! -e ~/sauce_is_ready ]; do sleep 1; done
    - sudo bash -c "echo \"127.0.0.1 portal.localhost\" >> /etc/hosts"
    - mkdir ./test/screenshots
    - npm start:
        background: true
    - npm test
  post:
    - killall --wait sc
    - mv ./test/screenshots/ $CIRCLE_ARTIFACTS/screenshots

deployment:
  prerelease:
    tag: /^\d+\.\d+\.\d+(-.*)$/
    commands:
      - cd dist && tar -czvf ../${TAG}.tgz *
      - aws s3 cp ${TAG}.tgz s3://formio-app-releases/${TAG}.tgz
  release:
    tag: /^\d+\.\d+\.\d+$/
    commands:
      - cd dist && tar -czvf ../${TAG}.tgz *
      - aws s3 cp ${TAG}.tgz s3://formio-app-releases/${TAG}.tgz
